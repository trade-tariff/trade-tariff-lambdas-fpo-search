#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail
set -o noclobber

# This script will take a source region ami id and replicate the ami into
# a destination region.
#
# If the destination region already has the ami, the script will exit with
# a 0 status code confirming that this version of the AMI already exists and therefore does not need to be copied
# Otherwise the script will copy the AMI to the destination region and exit with a 0 status code
SOURCE_AMI_ID=$1
SOURCE_REGION=${2:-us-east-1}
DESTINATION_REGION=$3
OWNER=$(aws sts get-caller-identity --query Account --output text)

fetch_source_ami_name() {
  aws ec2 describe-images \
    --region "$SOURCE_REGION" \
    --image-ids "$SOURCE_AMI_ID" \
    --owner "$OWNER" \
    --query 'Images[0].Name' \
    --output text
}

fetch_destination_ami_name_by_name() {
  aws ec2 describe-images \
    --region "$DESTINATION_REGION" \
    --filters "Name=name,Values=$1" \
    --owner "$OWNER" \
    --query 'Images[0].Name' \
    --output text
}

fetch_destination_ami_status_by_name() {
  aws ec2 describe-images \
    --region "$DESTINATION_REGION" \
    --filters "Name=name,Values=$1" \
    --owner "$OWNER" \
    --query 'Images[0].State' \
    --output text
}

copy_ami() {
  aws ec2 copy-image \
    --source-image-id "$SOURCE_AMI_ID" \
    --source-region "$SOURCE_REGION" \
    --region "$DESTINATION_REGION" \
    --name "$1"
}

wait_for_copy() {
  local image_name=$1
  local status="pending"
  while [ "$status" != "available" ]; do
    echo "AMI $image_name is $status in $DESTINATION_REGION"
    echo "Waiting..."
    sleep 30
    status=$(fetch_destination_ami_status_by_name "$image_name")
  done
}

USAGE="Usage: $0 <source-ami-id> <source-region> <destination-region>"

if [ "$SOURCE_AMI_ID" = "" ]; then
  echo "$USAGE"
  exit 1
fi

if [ "$SOURCE_REGION" = "" ]; then
  echo "$USAGE"
  exit 1
fi

if [ "$DESTINATION_REGION" = "" ]; then
  echo "$USAGE"
  exit 1
fi

main() {
  SOURCE_AMI_NAME=$(fetch_source_ami_name)
  DESTINATION_AMI_ID=$(fetch_destination_ami_name_by_name "$SOURCE_AMI_NAME")
  local ami_status
  ami_status=$(fetch_destination_ami_status_by_name "$SOURCE_AMI_NAME")

  if [ "$DESTINATION_AMI_ID" == None ]; then
    echo "Copying AMI $SOURCE_AMI_ID from $SOURCE_REGION to $DESTINATION_REGION"
    copy_ami "$SOURCE_AMI_NAME"
    wait_for_copy "$SOURCE_AMI_NAME"
    exit 0
  elif [ "$ami_status" == "available" ]; then
    echo "AMI $SOURCE_AMI_NAME already exists in $DESTINATION_REGION"
    exit 0
  elif [ "$ami_status" == "pending" ]; then
    echo "AMI $SOURCE_AMI_NAME is still being copied to $DESTINATION_REGION"
    exit 0
  else
    echo "AMI $SOURCE_AMI_NAME is in an unknown state in $DESTINATION_REGION"
    exit 1
  fi
}

main
